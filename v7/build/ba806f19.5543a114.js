(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{146:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return d})),n.d(t,"default",(function(){return c}));var r=n(2),a=n(10),o=(n(0),n(156)),i={id:"estimating-performance",title:"Esitmating emulators performance"},s={id:"estimating-performance",isDocsHomePage:!1,title:"Esitmating emulators performance",description:"Performance testing",source:"@site/docs/estimating-performance.md",permalink:"/v7/build/docs/estimating-performance",editUrl:"https://github.com/caiiiycuk/js-dos/edit/gh-pages/v7/docs/estimating-performance.md",sidebar:"someSidebar",previous:{title:"Releases",permalink:"/v7/build/docs/releases"}},d=[{value:"Performance testing",id:"performance-testing",children:[]},{value:"Creating js-dos bundle",id:"creating-js-dos-bundle",children:[]},{value:"Running the test",id:"running-the-test",children:[]}],l={rightToc:d};function c(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"performance-testing"},"Performance testing"),Object(o.b)("p",null,"To measure performance we used variant of Dhrystone 2 Test originally taken from this ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"http://www.roylongbottom.org.uk/dhrystone%20results.htm"}),"page"),". Original version used ",Object(o.b)("inlineCode",{parentName:"p"},"clock()")," to calculate delta time. Which is good for real pc, but does not very accurate for dosbox emulator. When ",Object(o.b)("inlineCode",{parentName:"p"},"clock()")," call happened modified version send ",Object(o.b)("inlineCode",{parentName:"p"},"~>dtime")," marker to stdout which intercepted by test page and used to calculate delta time with ",Object(o.b)("inlineCode",{parentName:"p"},"performance.now()")," from browser. Source code of modified test is ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/caiiiycuk/js-dos/tree/6.22/programms/dhry2"}),"here"),"."),Object(o.b)("p",null,"Basically this test produce a lot of int operations and measure amount of operations (Dhrystones) produced per second. Output is a ",Object(o.b)("inlineCode",{parentName:"p"},"VAX MIPS RATING")," which is Drhystones per second divided by 1757 (is as DEC VAX 11/780 result)."),Object(o.b)("h2",{id:"creating-js-dos-bundle"},"Creating js-dos bundle"),Object(o.b)("p",null,"To use this test progam we need to create ",Object(o.b)("inlineCode",{parentName:"p"},"js-dos bundle"),".\nPlease open in new tab ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://dos.zone/en/studio"}),"bundle generator"),".\nClick on ",Object(o.b)("inlineCode",{parentName:"p"},"Browse")," button, and choose ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"../bundles/dhry2.zip"}),"program archive"),"."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"../img/bundle_guide_1.jpg",alt:"Browser button"}))),Object(o.b)("p",null,"Next, you need to select executable that will be runned when DOS emulator starts. Please select ",Object(o.b)("inlineCode",{parentName:"p"},"dhry_2.exe"),"."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"../img/bundle_guide_2.jpg",alt:"Select executable"}))),Object(o.b)("p",null,"On next step you can change various of dosbox options, but usually defaults is pretty good. But for this guide we need\nto set cpu emulation to maximum speed, please scroll down to cpu section and set ",Object(o.b)("inlineCode",{parentName:"p"},"max")," option."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"../img/bundle_guide_5.jpg",alt:"Cpu maximum"}))),Object(o.b)("p",null,"Then scroll down and press ",Object(o.b)("inlineCode",{parentName:"p"},"create archive"),"."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"../img/bundle_guide_3.jpg",alt:"Create archive"}))),Object(o.b)("p",null,"Finally, you can download ",Object(o.b)("inlineCode",{parentName:"p"},"js-dos bundle"),"."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"../img/bundle_guide_4.jpg",alt:"Download archive"}))),Object(o.b)("p",null,"You can download ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"../bundles/dhry2.jsdos"}),"precreated bundle")," for test."),Object(o.b)("h2",{id:"running-the-test"},"Running the test"),Object(o.b)("p",null,"To run this test we need import ",Object(o.b)("inlineCode",{parentName:"p"},"emulators.js")," and use our ",Object(o.b)("inlineCode",{parentName:"p"},"js-dos bundle")," to start test."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-js",metastring:"live",live:!0}),'declare const emulators: any;\n\nfunction EstimateTest() {\n  // we need to set prefix where emulator wasm is located\n  emulators.pathPrefix = "/v7/build/releases/latest/emulators/";\n\n  let runId = 0;\n  function runBundle(bundle) {\n    const id = runId++;\n    const stdout = document.getElementById("stdout");\n\n    // here you can use also dosDirect\n    emulators.dosWorker(bundle)\n      // promise is resolved when emulator is started \n      .then((ci) => {\n        const time = [0, 0];\n        let timeIndex = 0;\n        let runs = 10000; \n        // listen program outpus for `~>dtime` marker\n        ci.events().onStdout((message) => {\n          if (message.indexOf("~>dtime") === -1) {\n            return;\n          }\n          \n          time[timeIndex++] = performance.now();\n          if (timeIndex === 2) {\n            const delta = time[1] - time[0];\n            stdout.innerHTML += (id) + ": " + runs + " runs, browser time " + delta + " ms, " +\n                 "VAX rating " + (runs * 1000 / delta / 1757) + "\\n";\n            runs *= 2;\n            timeIndex = 0;\n               \n            if (delta > 3000) {\n              //properly exit\n              ci.exit();\n             }\n            }\n        });\n      });\n  }\n\n  function onClick() {\n    const bundleUrl = "../bundles/dhry2.jsdos";\n\n    // we need to download bundle, emulators accept only Uint8Array\n    const xhr = new XMLHttpRequest();\n    xhr.open("GET", bundleUrl, true);\n    xhr.overrideMimeType("text/plain; charset=x-user-defined");\n    xhr.responseType = "arraybuffer";\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState === 4 && xhr.status === 200) {\n        // do not forget to create Uint8Array, \n        // arraybuffer will not work!\n        runBundle(new Uint8Array(xhr.response));\n      }\n    };\n    xhr.send();\n  };\n  \n  return (\n    <div>\n      <button onClick={onClick}>Start</button>\n      <pre id="stdout"></pre>\n    </div>\n  );\n}\n')),Object(o.b)("p",null,"Try to change ",Object(o.b)("inlineCode",{parentName:"p"},"dosWorker")," to ",Object(o.b)("inlineCode",{parentName:"p"},"dosDirect")," and see how result is changing.\nIn worker mode each test will run in new worker. If you press ",Object(o.b)("inlineCode",{parentName:"p"},"Start")," multiple times,\nthen you will see output from multiple threads. In direct mode browser will probably hangs."))}c.isMDXComponent=!0}}]);